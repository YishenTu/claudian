# Context Window Usage Tracking

Displays context window usage in the input toolbar as a 240° arc gauge with percentage.

## Implementation

### Types Added

**`src/core/types/chat.ts`**
```typescript
export interface UsageInfo {
  model?: string;
  inputTokens: number;
  cacheCreationInputTokens: number;
  cacheReadInputTokens: number;
  contextWindow: number;
  contextTokens: number;
  percentage: number;
}

// Extended StreamChunk with usage type
// Extended Conversation with optional usage field
```

**`src/core/types/sdk.ts`**
```typescript
export interface ModelUsageInfo {
  inputTokens?: number;
  cacheCreationInputTokens?: number;
  cacheReadInputTokens?: number;
  contextWindow?: number;
}

// Extended SDKMessage with modelUsage and model fields
```

### SDK Message Transformation

**`src/core/sdk/`** - Split into modules:
- `types.ts` - SessionInitEvent, TransformEvent
- `selectModelUsage.ts` - Selects model entry (prefers message.model, fallback to highest contextTokens)
- `transformSDKMessage.ts` - Yields `{ type: 'usage', usage }` chunk from result messages
- `typeGuards.ts` - isSessionInitEvent, isStreamChunk
- `index.ts` - Barrel export

### State Management

**`src/features/chat/state/types.ts`**
- Added `usage: UsageInfo | null` to `ChatStateData`
- Added `ignoreUsageUpdates: boolean` to `ChatStateData`
- Added `onUsageChanged` callback to `ChatStateCallbacks`

**`src/features/chat/state/ChatState.ts`**
- Added `usage` getter/setter with callback invocation
- Added `ignoreUsageUpdates` getter/setter for controlling updates
- Clears usage in `resetForNewConversation()`

### Stream Handling

**`src/features/chat/controllers/StreamController.ts`**
- Added `case 'usage'`: updates `state.usage` with filtering:
  - Ignores updates from mismatched session IDs
  - Respects `ignoreUsageUpdates` flag for session resets

### Persistence

**`src/features/chat/controllers/ConversationController.ts`**
- `save()`: includes `usage` in updates
- `loadActive()` / `switchTo()`: restores `state.usage` from conversation
- `createNew()`: clears `state.usage`

**`src/core/storage/SessionStorage.ts`**
- Added `usage` to `SessionMetaRecord`
- Serialized/parsed in JSONL first line

### UI Component

**`src/ui/components/InputToolbar.ts`** - Added `ContextUsageMeter` class:
- 240° arc gauge (16x16 SVG in 24x24 wrapper)
- Percentage text display
- Custom CSS tooltip showing "45k / 200k" on hover
- Hidden when no usage data

**`src/style/components/context-footer.css`**
- Inline toolbar styling matching folder/MCP icons
- Claude brand color (#D97757) for gauge fill
- CSS tooltip with `data-tooltip` attribute

### View Integration

**`src/features/chat/ClaudianView.ts`**
- `ContextUsageMeter` created via `createInputToolbar()`
- Wired to `onUsageChanged` callback in `ChatState` constructor
- Provides `resetContextMeter` callback to InputController

**`src/features/chat/controllers/InputController.ts`**
- Added `resetContextMeter` dep for clearing meter on session reset
- Sets `ignoreUsageUpdates = false` at query start
- Plan mode approval with new session: sets `ignoreUsageUpdates = true` and calls `resetContextMeter()`

## Data Flow

```
SDK result message (with modelUsage)
  ↓
transformSDKMessage() yields { type: 'usage', usage, sessionId }
  ↓
StreamController handles chunk:
  - Filters by sessionId (ignores mismatched sessions)
  - Checks ignoreUsageUpdates flag
  - Updates state.usage if allowed
  ↓
ChatState callback → onUsageChanged(usage)
  ↓
ContextUsageMeter.update() → renders gauge + percentage
  ↓
ConversationController.save() → SessionStorage JSONL meta
```

### Session Reset Flow (Plan Mode with New Session)

```
User approves plan with "Approve + New Session"
  ↓
InputController sets ignoreUsageUpdates = true
  ↓
InputController calls resetContextMeter() → meter hidden
  ↓
Session reset, new query starts
  ↓
InputController sets ignoreUsageUpdates = false
  ↓
New usage updates flow normally
```

## Files Changed

| File | Change |
|------|--------|
| `src/core/types/chat.ts` | Added UsageInfo, extended StreamChunk, Conversation |
| `src/core/types/sdk.ts` | Added ModelUsageInfo, extended SDKMessage |
| `src/core/types/index.ts` | Exported new types |
| `src/core/sdk/*` | Split MessageTransformer into modules, added usage extraction |
| `src/features/chat/state/types.ts` | Added usage and ignoreUsageUpdates to state |
| `src/features/chat/state/ChatState.ts` | Added usage and ignoreUsageUpdates properties |
| `src/features/chat/controllers/StreamController.ts` | Handle usage chunk with session/flag filtering |
| `src/features/chat/controllers/InputController.ts` | Added resetContextMeter dep, ignoreUsageUpdates control |
| `src/features/chat/controllers/ConversationController.ts` | Persist/restore usage |
| `src/core/storage/SessionStorage.ts` | Persist usage in JSONL meta |
| `src/ui/components/InputToolbar.ts` | Added ContextUsageMeter class |
| `src/ui/components/index.ts` | Exported ContextUsageMeter |
| `src/style/components/context-footer.css` | Meter styling |
| `src/style/index.css` | Import context-footer.css |
| `src/features/chat/ClaudianView.ts` | Wire meter to state callback, provide resetContextMeter |
| `src/style/toolbar/mcp-selector.css` | Changed accent to Claude brand color |

## Future Investigation

To check if more frequent meter updates are possible, add console logging in `transformSDKMessage.ts`:

```typescript
case 'result': {
  console.log('Result message received:', {
    hasModelUsage: !!message.modelUsage,
    model: message.model,
    timestamp: Date.now(),
  });
  // ... existing code
}
```

This will reveal if the SDK sends intermediate `result` messages after each tool call completes, or only once at the very end of the agentic loop. If intermediate results exist, the meter could update more frequently without estimation.

## UI Behavior

- **Location**: Input toolbar, between thinking selector and folder icon
- **Order**: Model → Thinking → **Meter** → Folder → MCP → YOLO
- **Display**: 240° arc gauge (16x16 SVG in 24x24 wrapper) with pointer needle + percentage (e.g., "26%")
- **Pointer**: Speedometer-style needle from center, rotates with percentage (150° at 0%, 390° at 100%)
- **Tooltip**: CSS tooltip on hover shows "45k / 200k" (tokens used / context window)
- **Visibility**: Hidden when no usage data (new conversation or missing contextWindow)
- **Persistence**: Restored when switching conversations or restarting Obsidian
- **Colors**:
  - Normal: Claude brand color (#D97757) for gauge fill, pointer, and percentage text
  - Warning (>80%): Pale red (#E57373) for gauge fill, pointer, and percentage text
- **Transitions**: Smooth 0.3s ease transitions for color changes
